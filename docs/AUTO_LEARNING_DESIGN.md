# 自動学習システム 設計書

**作成日**: 2026-02-02  
**目的**: 需要予測の精度を使えば使うほど自動で向上させる仕組み

---

## 1. 全体像

```
        毎日の自動同期（runDailySync）
              │
    ┌─────────┼─────────┐
    ▼         ▼         ▼
  商品同期  在庫同期  売上同期
              │
              ▼
    ┌── 🧠 自動学習（NEW）──┐
    │                        │
    │  ① 過去の予測と        │
    │     実績を比較          │
    │  ② 精度メトリクス計算   │
    │  ③ パラメータ調整       │
    │  ④ 学習結果をDBに保存   │
    └────────────────────────┘

        次回の発注予測時
              │
              ▼
    executeForecast()
    ├── 商品マスタ取得
    ├── 売上データ取得
    ├── 在庫データ取得
    ├── 🧠 学習済みパラメータ取得（NEW）
    ├── ABC分析
    └── 商品ごとの計算
        ├── 予測需要 × biasCorrection（学習済み）
        ├── 安全在庫 × safetyMultiplier（学習済み）
        ├── 曜日パターン × dowReliability（学習済み）
        └── 発注数算出
```

---

## 2. 学習サイクル

### Phase 1: 記録（予測実行時）

ユーザーが `/calculate` を叩くたびに、予測結果をスナップショットとして自動保存。

```
forecast_snapshots テーブル:
┌──────────┬────────────┬─────────────┬──────────────┬──────────┐
│ store_id │ product_id │ forecast_date│ predicted_qty│ abc_rank │
├──────────┼────────────┼─────────────┼──────────────┼──────────┤
│ 1        │ 12345      │ 2026-01-20  │ 23.4         │ A        │
│ 1        │ 12345      │ 2026-01-27  │ 21.8         │ A        │
│ 1        │ 12345      │ 2026-02-03  │ 25.1         │ A        │
└──────────┴────────────┴─────────────┴──────────────┴──────────┘
```

### Phase 2: 評価（毎日自動）

予測期間が過ぎたら、実際の売上と比較して精度を算出。

```
例: 1/20の予測「1/20〜1/26に23.4個売れる」
    → 1/27に実績を確認: 実際は19個だった

    MAPE = |23.4 - 19| / 19 = 23.2%
    バイアス = (23.4 - 19) / 19 = +23.2%（過大予測）
```

### Phase 3: 学習（毎日自動）

精度履歴から「この商品はいつも○○%多めに予測してしまう」等のパターンを検出し、パラメータを調整。

```
例: 商品12345の直近4週の平均バイアス = +20%（常に過大予測）
    → biasCorrection を 1.0 → 0.97 に調整（1回の調整は最大15%）
    → 3週間で biasCorrection = 0.97 → 0.94 → 0.91 と徐々に最適化
    → 次回予測: 23.4 × 0.91 = 21.3（実態に近づく）
```

### Phase 4: 適用（次回予測時）

`executeForecast()` が学習済みパラメータを自動読み込み、予測に反映。

---

## 3. 学習対象パラメータ（4つ）

### 3a. biasCorrection（バイアス補正）: 0.80 〜 1.20

**何を調整するか**: 予測需要の全体的な過大/過小傾向

```
過大予測が続く（実績 < 予測）→ biasCorrection を下げる
過小予測が続く（実績 > 予測）→ biasCorrection を上げる
```

**調整ルール**:
- 直近4週の平均バイアスが ±10% を超える場合のみ調整
- 1回の調整幅は最大15%（DAMPER = 0.15）
- 範囲: 0.80〜1.20（最大±20%の補正）
- 学習3サイクル以上でないと適用しない

**具体例**:
| 週 | 予測 | 実績 | バイアス | biasCorrection |
|----|------|------|---------|----------------|
| 1  | 23.4 | 19.0 | +23% | 1.00（初期） |
| 2  | 21.8 | 18.5 | +18% | 1.00（データ不足） |
| 3  | 25.1 | 20.0 | +26% | 0.97（学習開始） |
| 4  | 22.0 | 19.2 | +15% | 0.94 |
| 5  | 20.7×0.94=19.5 | 19.0 | +3% | 0.94（安定） |

→ 5週目で予測精度が23%→3%に改善。

### 3b. safetyMultiplier（安全在庫倍率）: 0.50 〜 2.00

**何を調整するか**: ABCランク別安全在庫の過不足

```
欠品が頻発（在庫日数 < 1日）→ safetyMultiplier を +0.1
過剰在庫（在庫日数 > 21日）→ safetyMultiplier を -0.1
適正範囲（1〜21日）→ 変更なし
```

**具体例**:
- Aランク商品、安全在庫ベース = 4個
- 3回連続で欠品 → safetyMultiplier: 1.0 → 1.1 → 1.2 → 1.3
- 調整後安全在庫: 4 × 1.3 = 5.2 → 5個
- 欠品が止まれば倍率は安定

### 3c. bestLookbackDays（最適参照日数）: 14 / 28 / 42 / 56

**何を調整するか**: 予測に使う過去データの期間

```
テスト: 14日 / 28日 / 42日 / 56日 の各参照日数で予測した場合の精度を比較
→ MAPEが最も低い参照日数を採用
```

**挙動**:
- 新商品や急に売れ始めた商品 → 14日（短期トレンドに追従）
- 安定した定番商品 → 56日（長期平均が安定）
- 季節商品 → 時期によって変動

### 3d. dowReliability（曜日パターン信頼度）: 0.0 〜 1.0

**何を調整するか**: 曜日別予測と単純平均のブレンド比率

```
dowReliability = 0.0 → 100%単純平均（曜日パターンを無視）
dowReliability = 1.0 → 100%曜日別予測（パターンを全面的に信頼）
dowReliability = 0.7 → 70%曜日別 + 30%単純平均
```

**計算**: MAPEが低い（予測精度が高い）ほど曜日パターンの信頼度を上げる。

---

## 4. 安全装置

### ダンパー（急変防止）

1回の学習で各パラメータは最大15%しか動かない。
→ 異常な1週間があっても暴走しない。

### 最低学習回数

パラメータの適用は3サイクル（≒3週間）以上の精度データが必要。
→ データ不足で誤った調整をしない。

### 範囲制限

| パラメータ | 最小 | 最大 | 意味 |
|-----------|------|------|------|
| biasCorrection | 0.80 | 1.20 | 最大±20%補正 |
| safetyMultiplier | 0.50 | 2.00 | 安全在庫の半分〜2倍 |
| dowReliability | 0.00 | 1.00 | 完全無視〜完全信頼 |

### テーブル未作成時の耐性

SQLを実行する前でもシステムは動作する。
- `getLearnedParams()` がエラー → 全パラメータがデフォルト値で動作
- `saveForecastSnapshot()` がエラー → 無視してレスポンス返却
- `runDailyLearning()` がエラー → ログ出力してスキップ

---

## 5. APIエンドポイント

| メソッド | パス | 用途 |
|---------|------|------|
| POST | `/api/forecast/calculate` | 予測実行（スナップショットも自動保存） |
| POST | `/api/forecast/learn` | 手動で学習を実行 |
| GET | `/api/forecast/accuracy/:storeId` | 精度ダッシュボード |

### 精度ダッシュボード レスポンス例

```json
GET /api/forecast/accuracy/1

{
  "success": true,
  "overall": {
    "mape": 18.5,         // 全体平均MAPE（%）
    "bias": 3.2,          // 全体バイアス（+は過大予測）
    "count": 1250         // 評価件数
  },
  "byRank": {
    "A": { "mape": 12.3, "count": 150 },
    "B": { "mape": 16.8, "count": 280 },
    "C": { "mape": 22.1, "count": 350 },
    "D": { "mape": 28.5, "count": 270 },
    "E": { "mape": 35.2, "count": 200 }
  },
  "trend": [
    { "week": "2026-01-06", "mape": 25.3 },
    { "week": "2026-01-13", "mape": 22.1 },
    { "week": "2026-01-20", "mape": 19.8 },
    { "week": "2026-01-27", "mape": 18.5 }
  ]
}
```

→ 週を追うごとにMAPEが下がっている = 自動学習が効いている。

---

## 6. DBテーブル

### forecast_snapshots（予測記録）
```sql
CREATE TABLE forecast_snapshots (
  store_id, product_id, forecast_date,    -- PK
  predicted_quantity, lookback_days,
  algorithm, abc_rank, safety_stock,
  recommended_order, evaluated BOOLEAN
);
```

### forecast_accuracy（精度記録）
```sql
CREATE TABLE forecast_accuracy (
  store_id, product_id, period_start,     -- PK
  predicted, actual, error, abs_error,
  mape, bias, evaluated_at
);
```

### product_forecast_params（学習済みパラメータ）
```sql
CREATE TABLE product_forecast_params (
  store_id, product_id,                   -- PK
  bias_correction, safety_multiplier,
  best_lookback_days, dow_reliability,
  weekly_mape, weekly_bias,
  learning_cycles, last_learned_at
);
```

---

## 7. 導入手順

### Step 1: テーブル作成

```bash
# Supabase SQL Editor で実行
# ファイル: backend/sql/create_learning_tables.sql
```

### Step 2: コードデプロイ

既にコードは統合済み。変更ファイル:
- `services/forecast-learner.ts`（新規）
- `services/forecast-engine.ts`（学習パラメータ読み込み追加）
- `routes/forecast.ts`（スナップショット保存 + 精度API追加）
- `index.ts`（日次同期に学習ジョブ追加）

### Step 3: 学習開始

テーブル作成後、**通常通り予測を使うだけ**で自動的に学習が始まる。

```
Week 1-2: スナップショットが蓄積（まだ学習なし）
Week 3:   最初の精度評価 → パラメータ調整開始
Week 4+:  毎日少しずつパラメータが最適化
Week 8+:  ほとんどの主力商品で精度が安定
```

### Step 4: 精度確認

```bash
# ブラウザまたはcurlで精度ダッシュボードを確認
GET /api/forecast/accuracy/1
```

---

## 8. 期待される効果

### 食品小売での典型的な改善幅

| メトリクス | 学習前 | 学習後（8週） | 改善 |
|-----------|--------|-------------|------|
| MAPE（全体） | 25-35% | 15-20% | -10〜15pt |
| MAPE（Aランク） | 15-20% | 8-12% | -7〜8pt |
| 欠品率 | 5-8% | 2-4% | 半減 |
| 過剰在庫率 | 15-20% | 8-12% | -7〜8pt |

### なぜMLフレームワークを使わないのか

1. **商品数×店舗数のスケール**: 数百商品×6店舗 = 数千パラメータセット。
   LightGBMやProphetのような重いモデルは不要。

2. **説明可能性**: 「なぜこの発注数なのか？」に答えられることが現場では重要。
   `breakdown`テキストに補正倍率が表示される。

3. **安定性**: MLモデルは過学習のリスクがある。
   4パラメータ × ダンパー付き調整は安定性が高い。

4. **インフラ**: Python環境やGPU不要。既存のNode.js/Supabaseで完結。
