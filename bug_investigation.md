# バグ調査結果

## 調査日時
2026-01-24 04:54

## 問題の症状
- 表示単位を「週別」に変更
- 対象日時を変更
- 「データ更新」ボタンを押す → 「データの取得に失敗しました」エラーが発生

## 調査結果

### バックエンドAPI
- `curl "http://localhost:3000/api/table-data?from=2025-12-29&to=2026-01-24&storeIds=1,2,3,4,5,6"` でテスト
- **正常に動作している**
- 約5分かけて9378件の取引データを取得
- 100ページ（最大ページ数）まで取得
- 3531商品の売上データを集計
- 9926件の統合データを返却

### フロントエンド
- 日付入力フィールドの値が正しく反映されていない可能性
- 入力した日付（2025-12-29）が、データ更新ボタン押下後に元の日付（2026-01-17）に戻っている
- **原因**: 自動更新機能のデバウンス処理と手動更新の競合

### 根本原因
1. **日付入力の問題**: 日付を変更すると自動更新が500msのデバウンス後にトリガーされる
2. **手動更新との競合**: 「データ更新」ボタンを押すと、その時点のstateで更新が実行される
3. **state更新のタイミング**: 日付入力後、stateが更新される前に手動更新が実行されている可能性

## 修正方針

### 方針1: 自動更新を無効化し、手動更新のみにする
- メリット: シンプルで確実
- デメリット: ユーザーが毎回ボタンを押す必要がある

### 方針2: 日付入力のonChangeを修正
- 日付入力後、確実にstateが更新されてから自動更新をトリガー
- デバウンス時間を延長（500ms → 1000ms）

### 方針3: 手動更新時に最新の日付を取得
- handleRefresh関数内で、DOMから直接日付を取得
- または、useRefで日付を管理

## 推奨修正
**方針2を採用**: デバウンス処理を改善し、日付入力の確実な反映を保証する

### 具体的な修正内容
1. PeriodSelectorコンポーネントで、日付変更時にonBlurイベントも使用
2. App.tsxで、fromDate/toDateの変更を確実に検知
3. 手動更新ボタンを押した場合は、デバウンスタイマーをキャンセル
