import { useState, useEffect, useCallback, useRef } from 'react';
import { Play, Download, TrendingUp, ChevronDown, ChevronUp } from 'lucide-react';
import ForecastTooltip from '../components/ForecastTooltip';

// å‹å®šç¾©
interface Store {
  storeId: string;  // APIã‹ã‚‰ã¯æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã•ã‚Œã‚‹
  storeName: string;
}

interface ForecastProduct {
  productId: string;
  productName: string;
  brandName: string;
  categoryName: string;
  supplierName: string;
  price: number;
  cost: number;
  currentStock: number;
  avgDailySales: number;
  forecastQuantity: number;
  safetyStock: number;
  recommendedOrder: number;
  orderAmount: number;
  rank: 'A' | 'B' | 'C' | 'D' | 'E';
  pastSales: number[];
  stdDev: number;
  trendFactor: number;
  weightedAvg: number;
}

interface SupplierGroup {
  supplierName: string;
  products: ForecastProduct[];
  totalOrderQuantity: number;
  totalOrderAmount: number;
}

interface AccuracyReport {
  totalAccuracy: number;
  byRank: { rank: string; accuracy: number; count: number }[];
  byDayOfWeek: { day: string; accuracy: number }[];
}

interface AdjustmentFactors {
  dayOfWeek: Record<string, number>;
  rank: Record<string, number>;
}

// è¤‡æ•°é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
interface MultiSelectDropdownProps {
  label: string;
  options: { value: string; label: string }[];
  selectedValues: string[];
  onChange: (values: string[]) => void;
  placeholder?: string;
}

const MultiSelectDropdown: React.FC<MultiSelectDropdownProps> = ({
  label,
  options,
  selectedValues,
  onChange,
  placeholder = 'å…¨ã¦',
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleToggle = (value: string) => {
    if (selectedValues.includes(value)) {
      onChange(selectedValues.filter(v => v !== value));
    } else {
      onChange([...selectedValues, value]);
    }
  };

  const handleSelectAll = () => {
    if (selectedValues.length === options.length) {
      onChange([]);
    } else {
      onChange(options.map(o => o.value));
    }
  };

  const displayText = selectedValues.length === 0
    ? placeholder
    : selectedValues.length === options.length
    ? 'å…¨ã¦'
    : `${selectedValues.length}ä»¶é¸æŠä¸­`;

  return (
    <div className="relative" ref={dropdownRef}>
      <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="w-full px-3 py-2 border rounded-lg text-left bg-white flex justify-between items-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      >
        <span className={selectedValues.length === 0 ? 'text-gray-400' : ''}>
          {displayText}
        </span>
        <svg className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-auto">
          {/* å…¨é¸æŠ/ã‚¯ãƒªã‚¢ */}
          <div className="sticky top-0 bg-gray-100 border-b px-3 py-2 flex items-center justify-between">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={selectedValues.length === options.length && options.length > 0}
                onChange={handleSelectAll}
                className="rounded"
              />
              <span className="text-sm font-medium">å…¨ã¦é¸æŠ</span>
            </label>
            <button
              type="button"
              onClick={() => onChange([])}
              className="text-sm text-blue-600 hover:text-blue-800 font-medium"
            >
              ã‚¯ãƒªã‚¢
            </button>
          </div>

          {/* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§ */}
          {options.map((option) => (
            <label
              key={option.value}
              className="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"
            >
              <input
                type="checkbox"
                checked={selectedValues.includes(option.value)}
                onChange={() => handleToggle(option.value)}
                className="rounded"
              />
              <span className="text-sm truncate">{option.label}</span>
            </label>
          ))}

          {options.length === 0 && (
            <div className="px-3 py-2 text-sm text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
          )}
        </div>
      )}
    </div>
  );
};

// ãƒ©ãƒ³ã‚¯è¨­å®šï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«æ–¹å¼ï¼‰
const RANK_CONFIG = {
  A: { threshold: 0.20, serviceLevel: 0.99, zValue: 2.33 },
  B: { threshold: 0.40, serviceLevel: 0.97, zValue: 1.88 },
  C: { threshold: 0.60, serviceLevel: 0.95, zValue: 1.65 },
  D: { threshold: 0.80, serviceLevel: 0.90, zValue: 1.28 },
  E: { threshold: 1.00, serviceLevel: 0.85, zValue: 1.04 },
};

const API_BASE_URL = import.meta.env.VITE_API_URL || 'https://fc-demand-forecast-production.up.railway.app';

// ãƒˆãƒ¬ãƒ³ãƒ‰ä¿‚æ•°ã®è¨ˆç®—
function calculateTrendFactor(dailySales: number[]): number {
  if (dailySales.length < 14) return 1.0;
  
  const recent = dailySales.slice(-14);
  const older = dailySales.slice(-28, -14);
  
  const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
  const olderAvg = older.length > 0 ? older.reduce((a, b) => a + b, 0) / older.length : recentAvg;
  
  if (olderAvg === 0) return 1.0;
  
  const factor = recentAvg / olderAvg;
  return Math.max(0.7, Math.min(1.5, factor));
}

// åŠ é‡ç§»å‹•å¹³å‡ã®è¨ˆç®—
function calculateWeightedAverage(dailySales: number[]): number {
  if (dailySales.length === 0) return 0;
  
  const weights = dailySales.map((_, i) => {
    const daysAgo = dailySales.length - i;
    if (daysAgo <= 7) return 3.0;
    if (daysAgo <= 14) return 2.0;
    if (daysAgo <= 21) return 1.5;
    if (daysAgo <= 30) return 1.0;
    return 0.5;
  });
  
  const weightedSum = dailySales.reduce((sum, val, i) => sum + val * weights[i], 0);
  const weightSum = weights.reduce((a, b) => a + b, 0);
  
  return weightSum > 0 ? weightedSum / weightSum : 0;
}

export function DemandForecast() {
  // çŠ¶æ…‹ç®¡ç†
  const [stores, setStores] = useState<Store[]>([]);
  const [categories, setCategories] = useState<string[]>([]);
  const [suppliers, setSuppliers] = useState<string[]>([]);
  const [selectedStores, setSelectedStores] = useState<string[]>([]);
  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);  // è¤‡æ•°é¸æŠã«å¤‰æ›´
  const [selectedSuppliers, setSelectedSuppliers] = useState<string[]>([]);    // è¤‡æ•°é¸æŠã«å¤‰æ›´
  
  const [forecastUnit, setForecastUnit] = useState<'daily' | 'weekly' | 'monthly'>('weekly');
  const [forecastPeriods, setForecastPeriods] = useState<number>(1);
  const [startDate, setStartDate] = useState<string>('');
  const [endDate, setEndDate] = useState<string>('');
  
  const [forecastResults, setForecastResults] = useState<ForecastProduct[]>([]);
  const [supplierGroups, setSupplierGroups] = useState<SupplierGroup[]>([]);
  const [groupBySupplier, setGroupBySupplier] = useState<boolean>(true);
  
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  
  const [accuracyReport, setAccuracyReport] = useState<AccuracyReport | null>(null);
  const [, setAdjustmentFactors] = useState<AdjustmentFactors | null>(null);
  const [showAccuracyPanel, setShowAccuracyPanel] = useState<boolean>(false);
  const [showFormulaDetail, setShowFormulaDetail] = useState<boolean>(false);
  
  const [pastPeriodLabels, setPastPeriodLabels] = useState<string[]>(['', '', '']);
  const [expandedSuppliers, setExpandedSuppliers] = useState<Set<string>>(new Set());
  const [forecastDays, setForecastDays] = useState<number>(7);

  // åˆæœŸåŒ–
  useEffect(() => {
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);
    
    setStartDate(nextWeek.toISOString().split('T')[0]);
    
    const endDateCalc = new Date(nextWeek);
    endDateCalc.setDate(nextWeek.getDate() + 6);
    setEndDate(endDateCalc.toISOString().split('T')[0]);
    
    fetchMasterData();
    fetchAdjustmentFactors();
    fetchAccuracyReport();
  }, []);

  // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
  const fetchMasterData = async () => {
    try {
      const [storesRes, categoriesRes, suppliersRes] = await Promise.all([
        fetch(`${API_BASE_URL}/api/stores`),
        fetch(`${API_BASE_URL}/api/categories`),
        fetch(`${API_BASE_URL}/api/suppliers`),
      ]);
      
      if (storesRes.ok) {
        const storesData = await storesRes.json();
        if (storesData.success && storesData.data) {
          setStores(storesData.data);
          setSelectedStores(storesData.data.map((s: Store) => s.storeId));
        }
      }
      
      if (categoriesRes.ok) {
        const categoriesData = await categoriesRes.json();
        if (categoriesData.success && categoriesData.data) {
          setCategories(categoriesData.data.map((c: { categoryName: string }) => c.categoryName));
        }
      }
      
      if (suppliersRes.ok) {
        const suppliersData = await suppliersRes.json();
        console.log('ä»•å…¥å…ˆãƒ‡ãƒ¼ã‚¿:', suppliersData);
        if (suppliersData.success) {
          // APIã¯æ–‡å­—åˆ—ã®é…åˆ—ã‚’ç›´æ¥è¿”ã™
          const supplierList = suppliersData.data || [];
          console.log('ä»•å…¥å…ˆãƒªã‚¹ãƒˆ:', supplierList.length, 'ä»¶');
          setSuppliers(supplierList);
        }
      }
    } catch (err) {
      console.error('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }
  };

  // èª¿æ•´ä¿‚æ•°å–å¾—
  const fetchAdjustmentFactors = async () => {
    try {
      const res = await fetch(`${API_BASE_URL}/api/forecast/adjustments`);
      if (res.ok) {
        const data = await res.json();
        if (data.success) {
          setAdjustmentFactors(data.adjustments);
        }
      }
    } catch (err) {
      console.error('èª¿æ•´ä¿‚æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }
  };

  // ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
  const fetchAccuracyReport = async () => {
    try {
      const res = await fetch(`${API_BASE_URL}/api/forecast/accuracy-report`);
      if (res.ok) {
        const data = await res.json();
        if (data.success && data.report) {
          setAccuracyReport(data.report);
        }
      }
    } catch (err) {
      console.error('ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }
  };

  // åº—èˆ—ã®çŸ­ç¸®åã‚’å–å¾—
  const getShortName = (storeName: string): string => {
    if (storeName.includes('ãƒ‹ãƒ¥ã‚¦ãƒãƒ³æ–°å®¿')) return 'æ–°å®¿';
    if (storeName.includes('æ¹˜å—')) return 'æ¹˜å—';
    if (storeName.includes('å­¦èŠ¸å¤§å­¦')) return 'å­¦å¤§';
    if (storeName.includes('ä»£å®˜å±±')) return 'ä»£å®˜å±±';
    if (storeName.includes('YYYard cafe')) return 'YYcafe';
    if (storeName.includes('YYYard')) return 'YYYard';
    return storeName.slice(0, 6);
  };

  // äºˆæ¸¬è¨ˆç®—
  const calculateForecast = useCallback(async () => {
    if (selectedStores.length === 0) {
      setError('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      // éå»ãƒ‡ãƒ¼ã‚¿ã®æœŸé–“ã‚’è¨ˆç®—ï¼ˆ3æœŸé–“åˆ†ï¼‰
      const start = new Date(startDate);
      const periodDays = forecastUnit === 'daily' ? 1 : forecastUnit === 'weekly' ? 7 : 30;
      const lookbackDays = periodDays * 3;
      
      // äºˆæ¸¬æœŸé–“ã®æ—¥æ•°ã‚’ä¿å­˜
      const calculatedForecastDays = periodDays * forecastPeriods;
      setForecastDays(calculatedForecastDays);
      
      const historyEnd = new Date(start);
      historyEnd.setDate(start.getDate() - 1);
      const historyStart = new Date(historyEnd);
      historyStart.setDate(historyEnd.getDate() - lookbackDays + 1);

      // éå»æœŸé–“ã®ãƒ©ãƒ™ãƒ«ã‚’è¨­å®š
      const labels: string[] = [];
      for (let i = 2; i >= 0; i--) {
        const periodStart = new Date(historyEnd);
        periodStart.setDate(historyEnd.getDate() - (i + 1) * periodDays + 1);
        const periodEnd = new Date(historyEnd);
        periodEnd.setDate(historyEnd.getDate() - i * periodDays);
        labels.push(`${periodStart.getMonth() + 1}/${periodStart.getDate()}ã€œ${periodEnd.getMonth() + 1}/${periodEnd.getDate()}`);
      }
      setPastPeriodLabels(labels);

      // å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—
      const params = new URLSearchParams({
        from: historyStart.toISOString().split('T')[0],
        to: historyEnd.toISOString().split('T')[0],
        storeIds: selectedStores.join(','),
      });

      const res = await fetch(`${API_BASE_URL}/api/forecast/sales-with-products?${params}`);
      if (!res.ok) {
        throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await res.json();
      if (!data.success) {
        throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const products = data.products || [];
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
      console.log('=== ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–‹å§‹ ===');
      console.log('å…¨å•†å“æ•°:', products.length);
      console.log('é¸æŠã‚«ãƒ†ã‚´ãƒª:', selectedCategories);
      console.log('é¸æŠä»•å…¥å…ˆ:', selectedSuppliers);
      
      if (products.length > 0) {
        const sample = products[0];
        console.log('ã‚µãƒ³ãƒ—ãƒ«å•†å“:', {
          productName: sample.productName,
          categoryName: sample.categoryName,
          supplierName: sample.supplierName,
        });
      }
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œï¼‰
      let filteredProducts = products;
      
      // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç©ºé…åˆ— = å…¨ã¦é¸æŠï¼‰
      if (selectedCategories.length > 0) {
        filteredProducts = filteredProducts.filter((p: any) => {
          const productCategory = (p.categoryName || '').trim();
          const match = selectedCategories.some(cat => cat.trim() === productCategory);
          return match;
        });
        console.log('ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:', filteredProducts.length, 'ä»¶');
      }
      
      // ä»•å…¥å…ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç©ºé…åˆ— = å…¨ã¦é¸æŠï¼‰
      if (selectedSuppliers.length > 0) {
        filteredProducts = filteredProducts.filter((p: any) => {
          const productSupplier = (p.supplierName || '').trim();
          const match = selectedSuppliers.some(sup => sup.trim() === productSupplier);
          return match;
        });
        console.log('ä»•å…¥å…ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:', filteredProducts.length, 'ä»¶');
      }
      
      console.log('æœ€çµ‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœ:', filteredProducts.length, 'ä»¶');

      // å£²ä¸Šé †ã«ã‚½ãƒ¼ãƒˆ
      filteredProducts.sort((a: any, b: any) => (b.totalSales || 0) - (a.totalSales || 0));

      // ç´¯ç©å£²ä¸Šæ¯”ç‡ã‚’è¨ˆç®—ã—ã¦ãƒ©ãƒ³ã‚¯ä»˜ã‘
      const totalSales = filteredProducts.reduce((sum: number, p: any) => sum + (p.totalSales || 0), 0);
      let cumulativeSales = 0;

      const forecastProducts: ForecastProduct[] = filteredProducts.map((p: any) => {
        cumulativeSales += p.totalSales || 0;
        const cumulativeRatio = totalSales > 0 ? cumulativeSales / totalSales : 0;

        // ãƒ©ãƒ³ã‚¯æ±ºå®š
        let rank: 'A' | 'B' | 'C' | 'D' | 'E' = 'E';
        if (cumulativeRatio <= RANK_CONFIG.A.threshold) rank = 'A';
        else if (cumulativeRatio <= RANK_CONFIG.B.threshold) rank = 'B';
        else if (cumulativeRatio <= RANK_CONFIG.C.threshold) rank = 'C';
        else if (cumulativeRatio <= RANK_CONFIG.D.threshold) rank = 'D';

        // æ—¥å¹³å‡å£²ä¸Š
        const avgDailySales = lookbackDays > 0 ? (p.totalQuantity || 0) / lookbackDays : 0;

        // æ¨™æº–åå·®ï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰
        const dailySales = p.dailySales || [];
        const mean = avgDailySales;
        const variance = dailySales.length > 0
          ? dailySales.reduce((sum: number, s: number) => sum + Math.pow(s - mean, 2), 0) / dailySales.length
          : Math.pow(avgDailySales * 0.3, 2);
        const stdDev = Math.sqrt(variance);

        // ãƒˆãƒ¬ãƒ³ãƒ‰ä¿‚æ•°ã¨åŠ é‡ç§»å‹•å¹³å‡ã‚’è¨ˆç®—
        const trendFactor = calculateTrendFactor(dailySales);
        const weightedAvg = dailySales.length > 0 ? calculateWeightedAverage(dailySales) : avgDailySales;

        // äºˆæ¸¬å£²æ•°ï¼ˆåŠ é‡ç§»å‹•å¹³å‡ + ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰
        const forecastQuantity = Math.round(weightedAvg * calculatedForecastDays * trendFactor);

        // å®‰å…¨åœ¨åº«ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«æ–¹å¼ï¼‰
        const zValue = RANK_CONFIG[rank].zValue;
        const safetyStock = Math.round(zValue * stdDev * Math.sqrt(calculatedForecastDays));

        // æ¨å¥¨ç™ºæ³¨æ•°
        // è¡¨ç¤ºç”¨ã¯å®Ÿéš›ã®åœ¨åº«æ•°ï¼ˆãƒã‚¤ãƒŠã‚¹å«ã‚€ï¼‰ã€è¨ˆç®—ç”¨ã¯ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã†
        const currentStock = p.stockTotal || 0;  // è¡¨ç¤ºç”¨ï¼ˆãƒã‚¤ãƒŠã‚¹ã‚‚ãã®ã¾ã¾è¡¨ç¤ºï¼‰
        const stockForCalculation = Math.max(0, currentStock);  // è¨ˆç®—ç”¨ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯0ã¨ã—ã¦æ‰±ã†ï¼‰
        const recommendedOrder = Math.max(0, forecastQuantity + safetyStock - stockForCalculation);

        // ç™ºæ³¨é‡‘é¡
        const orderAmount = recommendedOrder * (p.cost || 0);

        // éå»3æœŸé–“ã®å£²ä¸Š
        const pastSales: number[] = [];
        for (let i = 0; i < 3; i++) {
          const periodSales = Math.round(avgDailySales * periodDays);
          pastSales.push(periodSales > 0 ? periodSales : 0);
        }

        return {
          productId: p.productId,
          productName: p.productName,
          brandName: p.brandName || '-',
          categoryName: p.categoryName || '-',
          supplierName: p.supplierName || '-',
          price: p.price || 0,
          cost: p.cost || 0,
          currentStock,
          avgDailySales: parseFloat(avgDailySales.toFixed(1)),
          forecastQuantity,
          safetyStock,
          recommendedOrder,
          orderAmount,
          rank,
          pastSales,
          stdDev,
          trendFactor,
          weightedAvg,
        };
      });

      // ç™ºæ³¨ãŒå¿…è¦ãªå•†å“ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
      const productsWithOrder = forecastProducts.filter(p => p.recommendedOrder > 0);

      setForecastResults(productsWithOrder);

      // ä»•å…¥å…ˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groups: Record<string, ForecastProduct[]> = {};
      productsWithOrder.forEach(p => {
        const supplier = p.supplierName || 'æœªè¨­å®š';
        if (!groups[supplier]) groups[supplier] = [];
        groups[supplier].push(p);
      });

      const supplierGroupsArray: SupplierGroup[] = Object.entries(groups).map(([name, prods]) => ({
        supplierName: name,
        products: prods,
        totalOrderQuantity: prods.reduce((sum, p) => sum + p.recommendedOrder, 0),
        totalOrderAmount: prods.reduce((sum, p) => sum + p.orderAmount, 0),
      }));

      // ç™ºæ³¨é‡‘é¡é †ã«ã‚½ãƒ¼ãƒˆ
      supplierGroupsArray.sort((a, b) => b.totalOrderAmount - a.totalOrderAmount);

      setSupplierGroups(supplierGroupsArray);
      
      // å…¨ã¦ã®ä»•å…¥å…ˆã‚’å±•é–‹çŠ¶æ…‹ã«ã™ã‚‹
      setExpandedSuppliers(new Set(supplierGroupsArray.map(g => g.supplierName)));

    } catch (err: any) {
      setError(err.message || 'äºˆæ¸¬è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  }, [selectedStores, selectedCategories, selectedSuppliers, startDate, endDate, forecastUnit, forecastPeriods]);

  // ä»•å…¥å…ˆã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
  const toggleSupplier = (supplierName: string) => {
    setExpandedSuppliers(prev => {
      const next = new Set(prev);
      if (next.has(supplierName)) {
        next.delete(supplierName);
      } else {
        next.add(supplierName);
      }
      return next;
    });
  };

  // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const downloadCSV = (products: ForecastProduct[], filename: string) => {
    const headers = [
      'å•†å“å', 'ãƒ–ãƒ©ãƒ³ãƒ‰', 'ã‚«ãƒ†ã‚´ãƒª', 'ä»•å…¥å…ˆ', 'å˜ä¾¡', 'åŸä¾¡', 'åœ¨åº«',
      'æ—¥å¹³å‡', 'äºˆæ¸¬å£²æ•°', 'å®‰å…¨åœ¨åº«', 'æ¨å¥¨ç™ºæ³¨', 'ç™ºæ³¨é‡‘é¡', 'ãƒ©ãƒ³ã‚¯'
    ];

    const rows = products.map(p => [
      p.productName,
      p.brandName,
      p.categoryName,
      p.supplierName,
      p.price,
      p.cost,
      p.currentStock,
      p.avgDailySales,
      p.forecastQuantity,
      p.safetyStock,
      p.recommendedOrder,
      p.orderAmount,
      p.rank,
    ]);

    const csvContent = '\uFEFF' + [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
  };

  const downloadAllCSV = () => {
    downloadCSV(forecastResults, `éœ€è¦äºˆæ¸¬_å…¨ä½“_${startDate}_${endDate}.csv`);
  };

  const downloadSupplierCSV = (group: SupplierGroup) => {
    downloadCSV(group.products, `éœ€è¦äºˆæ¸¬_${group.supplierName}_${startDate}_${endDate}.csv`);
  };

  // ç™ºæ³¨ã‚µãƒãƒªãƒ¼è¨ˆç®—
  const totalOrderQuantity = forecastResults.reduce((sum, p) => sum + p.recommendedOrder, 0);
  const totalOrderAmount = forecastResults.reduce((sum, p) => sum + p.orderAmount, 0);

  // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  const renderTableHeader = (includeSupplier: boolean = false) => (
    <thead className="sticky top-0 z-10">
      <tr className="text-xs">
        {/* å•†å“æƒ…å ±ï¼ˆç™½èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-left bg-white border-b border-r font-semibold min-w-[180px]">å•†å“å</th>
        <th className="px-3 py-2 text-left bg-white border-b border-r font-semibold min-w-[100px]">ãƒ–ãƒ©ãƒ³ãƒ‰</th>
        <th className="px-3 py-2 text-left bg-white border-b border-r font-semibold min-w-[100px]">ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
        {includeSupplier && (
          <th className="px-3 py-2 text-left bg-white border-b border-r font-semibold min-w-[100px]">ä»•å…¥å…ˆ</th>
        )}
        
        {/* ä¾¡æ ¼æƒ…å ±ï¼ˆã‚°ãƒ¬ãƒ¼èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-right bg-gray-100 border-b border-r font-semibold min-w-[70px]">å˜ä¾¡</th>
        <th className="px-3 py-2 text-right bg-gray-100 border-b border-r font-semibold min-w-[70px]">åŸä¾¡</th>
        
        {/* åœ¨åº«ï¼ˆé’èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-right bg-blue-50 border-b border-r font-semibold min-w-[60px]">
          <div className="flex flex-col items-end">
            <span>åœ¨åº«</span>
            <span className="text-[10px] text-gray-500 font-normal">â€»å‰å›æ›´æ–°æ™‚ç‚¹</span>
          </div>
        </th>
        
        {/* éå»å£²ä¸Šï¼ˆè–„ã„ç·‘èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-right bg-green-50 border-b border-r font-semibold min-w-[80px]">{pastPeriodLabels[0]}</th>
        <th className="px-3 py-2 text-right bg-green-50 border-b border-r font-semibold min-w-[80px]">{pastPeriodLabels[1]}</th>
        <th className="px-3 py-2 text-right bg-green-50 border-b border-r font-semibold min-w-[80px]">{pastPeriodLabels[2]}</th>
        
        {/* äºˆæ¸¬æƒ…å ±ï¼ˆé»„è‰²èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-right bg-yellow-50 border-b border-r font-semibold min-w-[60px]">æ—¥å¹³å‡</th>
        <th className="px-3 py-2 text-right bg-yellow-50 border-b border-r font-semibold min-w-[70px]">äºˆæ¸¬å£²æ•°</th>
        <th className="px-3 py-2 text-right bg-yellow-50 border-b border-r font-semibold min-w-[70px]">å®‰å…¨åœ¨åº«</th>
        
        {/* ç™ºæ³¨æƒ…å ±ï¼ˆé»„è‰²èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-right bg-yellow-100 border-b border-r font-semibold min-w-[70px]">æ¨å¥¨ç™ºæ³¨</th>
        <th className="px-3 py-2 text-right bg-yellow-100 border-b border-r font-semibold min-w-[90px]">ç™ºæ³¨é‡‘é¡</th>
        
        {/* ãƒ©ãƒ³ã‚¯ï¼ˆè–„ç·‘èƒŒæ™¯ï¼‰ */}
        <th className="px-3 py-2 text-center bg-green-50 border-b font-semibold min-w-[60px]">ãƒ©ãƒ³ã‚¯</th>
      </tr>
    </thead>
  );

  // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  const renderTableRow = (p: ForecastProduct, idx: number, includeSupplier: boolean = false) => (
    <tr 
      key={p.productId} 
      className={`text-xs hover:bg-blue-50/50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}
    >
      {/* å•†å“æƒ…å ± */}
      <td className="px-3 py-2 text-left border-b border-r font-medium truncate max-w-[180px]" title={p.productName}>
        {p.productName}
      </td>
      <td className="px-3 py-2 text-left border-b border-r text-gray-600 truncate max-w-[100px]" title={p.brandName}>
        {p.brandName || '-'}
      </td>
      <td className="px-3 py-2 text-left border-b border-r text-gray-600 truncate max-w-[100px]" title={p.categoryName}>
        {p.categoryName || '-'}
      </td>
      {includeSupplier && (
        <td className="px-3 py-2 text-left border-b border-r text-gray-600 truncate max-w-[100px]" title={p.supplierName}>
          {p.supplierName || '-'}
        </td>
      )}
      
      {/* ä¾¡æ ¼æƒ…å ± */}
      <td className="px-3 py-2 text-right border-b border-r">
        Â¥{p.price.toLocaleString()}
      </td>
      <td className="px-3 py-2 text-right border-b border-r">
        Â¥{p.cost.toLocaleString()}
      </td>
      
      {/* åœ¨åº« */}
      <td className={`px-3 py-2 text-right border-b border-r ${p.currentStock < 0 ? 'text-red-600' : ''}`}>
        {p.currentStock}
      </td>
      
      {/* éå»å£²ä¸Š */}
      {p.pastSales.map((sales, i) => (
        <td key={i} className="px-3 py-2 text-right border-b border-r">
          {sales}
        </td>
      ))}
      
      {/* äºˆæ¸¬æƒ…å ± */}
      <td className="px-3 py-2 text-right border-b border-r">
        {p.avgDailySales}
      </td>
      <td className="px-3 py-2 text-right border-b border-r">
        <ForecastTooltip
          product={{
            productName: p.productName,
            avgDailySales: p.avgDailySales,
            forecastQuantity: p.forecastQuantity,
            safetyStock: p.safetyStock,
            recommendedOrder: p.recommendedOrder,
            currentStock: p.currentStock,
            rank: p.rank,
            stdDev: p.stdDev,
            trendFactor: p.trendFactor,
            weightedAvg: p.weightedAvg,
          }}
          forecastDays={forecastDays}
        >
          <span className="cursor-help underline decoration-dotted">
            {p.forecastQuantity}
          </span>
        </ForecastTooltip>
      </td>
      <td className="px-3 py-2 text-right border-b border-r">
        {p.safetyStock}
      </td>
      
      {/* ç™ºæ³¨æƒ…å ± */}
      <td className="px-3 py-2 text-right border-b border-r font-semibold text-blue-600">
        {p.recommendedOrder}
      </td>
      <td className="px-3 py-2 text-right border-b border-r font-semibold">
        Â¥{p.orderAmount.toLocaleString()}
      </td>
      
      {/* ãƒ©ãƒ³ã‚¯ */}
      <td className="px-3 py-2 text-center border-b">
        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
          p.rank === 'A' ? 'bg-red-100 text-red-700' :
          p.rank === 'B' ? 'bg-orange-100 text-orange-700' :
          p.rank === 'C' ? 'bg-yellow-100 text-yellow-700' :
          p.rank === 'D' ? 'bg-green-100 text-green-700' :
          'bg-gray-100 text-gray-700'
        }`}>
          {p.rank}
        </span>
      </td>
    </tr>
  );

  return (
    <div className="p-6">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">éœ€è¦äºˆæ¸¬</h1>
        <button
          onClick={calculateForecast}
          disabled={isLoading}
          className="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
        >
          <Play className="w-5 h-5" />
          {isLoading ? 'è¨ˆç®—ä¸­...' : 'äºˆæ¸¬ã‚’å®Ÿè¡Œ'}
        </button>
      </div>

      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
          {error}
        </div>
      )}

      {/* ç²¾åº¦ãƒ‘ãƒãƒ« */}
      {showAccuracyPanel && accuracyReport && (
        <div className="bg-white rounded-lg shadow p-4 mb-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold flex items-center gap-2">
              <TrendingUp className="w-5 h-5" />
              äºˆæ¸¬ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆ
            </h2>
            <button
              onClick={() => setShowAccuracyPanel(false)}
              className="text-gray-400 hover:text-gray-600"
            >
              âœ•
            </button>
          </div>
          <div className="text-center mb-4">
            <span className="text-4xl font-bold text-blue-600">{accuracyReport.totalAccuracy.toFixed(1)}%</span>
            <span className="text-gray-500 ml-2">å…¨ä½“ç²¾åº¦</span>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <h4 className="text-sm font-medium mb-2">ãƒ©ãƒ³ã‚¯åˆ¥ç²¾åº¦</h4>
              {accuracyReport.byRank.map(r => (
                <div key={r.rank} className="flex justify-between text-sm">
                  <span>ãƒ©ãƒ³ã‚¯ {r.rank}</span>
                  <span>{r.accuracy.toFixed(1)}% ({r.count}ä»¶)</span>
                </div>
              ))}
            </div>
            <div>
              <h4 className="text-sm font-medium mb-2">æ›œæ—¥åˆ¥ç²¾åº¦</h4>
              {accuracyReport.byDayOfWeek.map(d => (
                <div key={d.day} className="flex justify-between text-sm">
                  <span>{d.day}</span>
                  <span>{d.accuracy.toFixed(1)}%</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* äºˆæ¸¬æ¡ä»¶ */}
      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <h2 className="text-lg font-semibold mb-4">äºˆæ¸¬æ¡ä»¶</h2>
        
        <div className="grid grid-cols-4 gap-4 mb-4">
          {/* äºˆæ¸¬å˜ä½ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">äºˆæ¸¬å˜ä½</label>
            <select
              value={forecastUnit}
              onChange={(e) => setForecastUnit(e.target.value as 'daily' | 'weekly' | 'monthly')}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="daily">æ—¥æ¬¡</option>
              <option value="weekly">é€±æ¬¡</option>
              <option value="monthly">æœˆæ¬¡</option>
            </select>
          </div>
          
          {/* äºˆæ¸¬æœŸé–“ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">äºˆæ¸¬æœŸé–“ï¼ˆé€±ï¼‰</label>
            <select
              value={forecastPeriods}
              onChange={(e) => setForecastPeriods(parseInt(e.target.value))}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value={1}>1</option>
              <option value={2}>2</option>
              <option value={3}>3</option>
              <option value={4}>4</option>
            </select>
          </div>
          
          {/* é–‹å§‹æ—¥ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥</label>
            <input
              type="date"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          {/* çµ‚äº†æ—¥ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">çµ‚äº†æ—¥</label>
            <input
              type="date"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>

        <div className="grid grid-cols-3 gap-4">
          {/* å¯¾è±¡åº—èˆ— */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">å¯¾è±¡åº—èˆ—</label>
            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setSelectedStores(stores.map(s => s.storeId))}
                className={`px-3 py-1 rounded text-sm ${
                  selectedStores.length === stores.length ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                }`}
              >
                å…¨åº—èˆ—
              </button>
              {stores.map(store => (
                <label key={store.storeId} className="flex items-center gap-1">
                  <input
                    type="checkbox"
                    checked={selectedStores.includes(store.storeId)}
                    onChange={(e) => {
                      if (e.target.checked) {
                        setSelectedStores([...selectedStores, store.storeId]);
                      } else {
                        setSelectedStores(selectedStores.filter(id => id !== store.storeId));
                      }
                    }}
                    className="rounded text-blue-600"
                  />
                  <span className="text-sm">{getShortName(store.storeName)}</span>
                </label>
              ))}
            </div>
          </div>
          
          {/* ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°é¸æŠï¼‰ */}
          <MultiSelectDropdown
            label="ã‚«ãƒ†ã‚´ãƒª"
            options={categories.map(c => ({
              value: c,
              label: c,
            }))}
            selectedValues={selectedCategories}
            onChange={setSelectedCategories}
            placeholder="å…¨ã¦"
          />
          
          {/* ä»•å…¥å…ˆï¼ˆè¤‡æ•°é¸æŠï¼‰ */}
          <MultiSelectDropdown
            label="ä»•å…¥å…ˆ"
            options={suppliers.map(s => ({
              value: s,
              label: s,
            }))}
            selectedValues={selectedSuppliers}
            onChange={setSelectedSuppliers}
            placeholder="å…¨ã¦"
          />
        </div>
      </div>

      {/* è¨ˆç®—å¼ãƒ‘ãƒãƒ« */}
      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex items-center justify-between mb-3">
          <h2 className="font-semibold text-gray-700 flex items-center gap-2">
            <span>ğŸ“</span> äºˆæ¸¬è¨ˆç®—å¼
          </h2>
          <button
            onClick={() => setShowFormulaDetail(!showFormulaDetail)}
            className="text-sm text-blue-600 hover:text-blue-800"
          >
            {showFormulaDetail ? 'ç°¡æ˜“è¡¨ç¤º' : 'è©³ç´°ã‚’è¦‹ã‚‹'}
          </button>
        </div>
        
        {/* ç°¡æ˜“è¡¨ç¤º */}
        <div className="text-sm text-gray-600 space-y-1">
          <div className="flex items-center gap-2">
            <span className="font-medium text-gray-800">äºˆæ¸¬å£²æ•°</span>
            <span>=</span>
            <span>åŠ é‡ç§»å‹•å¹³å‡ Ã— äºˆæ¸¬æ—¥æ•° Ã— ãƒˆãƒ¬ãƒ³ãƒ‰ä¿‚æ•°</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="font-medium text-gray-800">æ¨å¥¨ç™ºæ³¨</span>
            <span>=</span>
            <span>äºˆæ¸¬å£²æ•° + å®‰å…¨åœ¨åº« âˆ’ ç¾åœ¨åº«</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="font-medium text-gray-800">å®‰å…¨åœ¨åº«</span>
            <span>=</span>
            <span>Zå€¤(ãƒ©ãƒ³ã‚¯åˆ¥) Ã— æ¨™æº–åå·® Ã— âˆšäºˆæ¸¬æ—¥æ•°</span>
          </div>
        </div>
        
        {/* è©³ç´°è¡¨ç¤º */}
        {showFormulaDetail && (
          <div className="mt-4 pt-4 border-t">
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <h4 className="font-medium mb-2">åŠ é‡ç§»å‹•å¹³å‡ã®é‡ã¿</h4>
                <ul className="text-gray-600 space-y-1">
                  <li>ç›´è¿‘7æ—¥: 3.0å€</li>
                  <li>8-14æ—¥å‰: 2.0å€</li>
                  <li>15-21æ—¥å‰: 1.5å€</li>
                  <li>22-30æ—¥å‰: 1.0å€</li>
                  <li>31æ—¥ä»¥å‰: 0.5å€</li>
                </ul>
              </div>
              <div>
                <h4 className="font-medium mb-2">ãƒ©ãƒ³ã‚¯åˆ¥Zå€¤ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«ï¼‰</h4>
                <ul className="text-gray-600 space-y-1">
                  <li>A: 2.33 (99%)</li>
                  <li>B: 1.88 (97%)</li>
                  <li>C: 1.65 (95%)</li>
                  <li>D: 1.28 (90%)</li>
                  <li>E: 1.04 (85%)</li>
                </ul>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* çµæœè¡¨ç¤º */}
      {forecastResults.length > 0 && (
        <>
          {/* ç™ºæ³¨ã‚µãƒãƒªãƒ¼ */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow p-4 mb-6">
            <h2 className="text-lg font-semibold mb-4">ç™ºæ³¨ã‚µãƒãƒªãƒ¼</h2>
            <div className="grid grid-cols-3 gap-4">
              <div className="bg-white rounded-lg p-4 text-center">
                <div className="text-sm text-gray-500">å¯¾è±¡å•†å“æ•°</div>
                <div className="text-2xl font-bold text-blue-600">{forecastResults.length} ä»¶</div>
              </div>
              <div className="bg-white rounded-lg p-4 text-center">
                <div className="text-sm text-gray-500">ç™ºæ³¨åˆè¨ˆæ•°</div>
                <div className="text-2xl font-bold text-orange-600">{totalOrderQuantity.toLocaleString()} å€‹</div>
              </div>
              <div className="bg-white rounded-lg p-4 text-center">
                <div className="text-sm text-gray-500">ç™ºæ³¨åˆè¨ˆé‡‘é¡</div>
                <div className="text-2xl font-bold text-green-600">Â¥{totalOrderAmount.toLocaleString()}</div>
              </div>
            </div>
          </div>

          {/* ç™ºæ³¨æ¨å¥¨ãƒªã‚¹ãƒˆ */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b flex justify-between items-center">
              <h2 className="text-lg font-semibold">ç™ºæ³¨æ¨å¥¨ãƒªã‚¹ãƒˆ</h2>
              <div className="flex items-center gap-4">
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={groupBySupplier}
                    onChange={(e) => setGroupBySupplier(e.target.checked)}
                    className="rounded text-blue-600"
                  />
                  <span className="text-sm">ä»•å…¥å…ˆã”ã¨ã«è¡¨ç¤º</span>
                </label>
                <button
                  onClick={downloadAllCSV}
                  className="flex items-center gap-1 px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded"
                >
                  <Download className="w-4 h-4" />
                  å…¨ä½“CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
              </div>
            </div>

            {groupBySupplier ? (
              // ä»•å…¥å…ˆã”ã¨ã«è¡¨ç¤º
              <div>
                {supplierGroups.map(group => (
                  <div key={group.supplierName} className="border-b last:border-b-0">
                    <div
                      className="flex items-center justify-between p-3 bg-gray-50 cursor-pointer hover:bg-gray-100"
                      onClick={() => toggleSupplier(group.supplierName)}
                    >
                      <div className="flex items-center gap-2">
                        {expandedSuppliers.has(group.supplierName) ? (
                          <ChevronUp className="w-4 h-4" />
                        ) : (
                          <ChevronDown className="w-4 h-4" />
                        )}
                        <span className="font-medium">{group.supplierName}</span>
                        <span className="text-sm text-gray-500">ï¼ˆ{group.products.length}ä»¶ï¼‰</span>
                      </div>
                      <div className="flex items-center gap-4">
                        <span className="text-sm">ç™ºæ³¨æ•°: <span className="font-semibold text-orange-600">{group.totalOrderQuantity}</span> å€‹</span>
                        <span className="text-sm">ç™ºæ³¨é‡‘é¡: <span className="font-semibold text-green-600">Â¥{group.totalOrderAmount.toLocaleString()}</span></span>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            downloadSupplierCSV(group);
                          }}
                          className="flex items-center gap-1 px-2 py-1 text-xs bg-white border rounded hover:bg-gray-50"
                        >
                          CSV
                        </button>
                      </div>
                    </div>
                    {expandedSuppliers.has(group.supplierName) && (
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          {renderTableHeader(false)}
                          <tbody>
                            {group.products.map((p, idx) => renderTableRow(p, idx, false))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              // å…¨å•†å“ã‚’ä¸€è¦§è¡¨ç¤º
              <div className="overflow-x-auto">
                <table className="w-full">
                  {renderTableHeader(true)}
                  <tbody>
                    {forecastResults.map((p, idx) => renderTableRow(p, idx, true))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </>
      )}

      {/* åˆæœŸçŠ¶æ…‹ */}
      {forecastResults.length === 0 && !isLoading && !error && (
        <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
          ã€Œäºˆæ¸¬ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦éœ€è¦äºˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
        </div>
      )}
    </div>
  );
}
