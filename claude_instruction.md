# Claudeへの指示書: スマレジ在庫データ取得の修正

## 1. 目的

需要予測システムの在庫データがスマレジの実際の在庫と一致しない問題を解決する。

具体的には、スマレジAPIから正しい在庫データを取得し、Supabaseの`stock_cache`テーブルを更新するバックエンド処理を修正する。

## 2. 現状のシステム構成

- **フロントエンド**: React, TypeScript, Vercel
- **バックエンド**: Node.js, Express, TypeScript, Railway
- **データベース**: Supabase (PostgreSQL)
- **外部API**: スマレジAPI

## 3. 問題点

### 3.1. 在庫データが一致しない

- **現象**: 需要予測システムが認識している在庫金額（約1,000万円）が、スマレジの実際の在庫金額（約220万円）と比べて約5倍になっている。
- **原因**: バックエンドが参照している`stock_cache`テーブルのデータが、スマレジのPOS API `/stock`エンドポイントから取得したものであり、これは**在庫管理画面（Inventory）のデータと異なる**。
- **仮説**: POS APIの`/stock`は「累計在庫変動」を返しており、「現在在庫」ではない可能性がある。

### 3.2. 店舗IDのマッピングミス

- **現象**: フロントエンドで「新宿店」を選択しても、実際には「湘南T-SITE店」のデータが表示されていた。
- **原因**: フロントエンドに店舗IDがハードコーディングされており、マッピングが間違っていた。
- **対応**: APIから店舗一覧を取得するように修正済み。

## 4. 依頼事項

スマレジAPIから**在庫管理画面（Inventory）と同じ「現在在庫」**を取得できるように、バックエンドの在庫同期処理を修正してほしい。

### 4.1. 調査

1. **スマレジAPIドキュメントの確認**: 
   - 在庫管理画面（Inventory）のデータを取得するための正しいAPIエンドポイントを特定する。
   - POS APIの`/stock`が何を返すのかを再確認する。
   - 必要であれば、スマレジのサポートに問い合わせる。

2. **現在のコードの確認**: 
   - `backend/src/services/smaregi/stock.ts`の`getStock`関数が`/stock`エンドポイントを呼び出していることを確認する。
   - `backend/src/services/sync/stockSync.ts`が`getStock`を呼び出し、`stock_cache`テーブルを更新していることを確認する。

### 4.2. 修正

1. **APIクライアントの修正**: 
   - `backend/src/services/smaregi/stock.ts`の`getStock`関数を修正し、正しいAPIエンドポイント（調査で特定したもの）を呼び出すように変更する。
   - レスポンスのデータ構造が異なる場合は、`Stock`型も合わせて修正する。

2. **同期処理の修正**: 
   - `backend/src/services/sync/stockSync.ts`の`syncStock`関数が、新しい`getStock`関数を正しく呼び出し、`stock_cache`テーブルを更新できるようにする。
   - 店舗ID (`storeId`)、商品ID (`productId`)、在庫数 (`stockAmount`) が正しくマッピングされていることを確認する。

### 4.3. テスト

1. **手動テスト**: 
   - 修正したバックエンドをローカルで実行し、在庫同期API (`/api/sync/stock`) を手動で呼び出す。
   - Supabaseの`stock_cache`テーブルが、スマレジの在庫管理画面のデータと一致することを確認する。
   - 特に、新宿店の在庫データ（商品数、在庫数、在庫金額）が一致することを重点的に確認する。

2. **シミュレーションの再実行**: 
   - 在庫データが正しくなったことを確認後、再度需要予測シミュレーションを実行し、結果が妥当であることを確認する。

## 5. 補足情報

- **スマレジAPIクライアント**: `backend/src/services/smaregi/client.ts`
- **認証情報**: 環境変数から取得 (`config.smaregi`)
- **関連ファイル**: 
  - `backend/src/routes/forecast.ts` (在庫データを参照)
  - `analysis/shinjuku_csv_simulation.py` (CSVを使ったシミュレーション)

以上、よろしくお願いします。
